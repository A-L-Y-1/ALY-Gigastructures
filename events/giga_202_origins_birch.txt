namespace = giga_birch

country_event = {
	id = giga_birch.001
	hide_window = yes
	fire_only_once = yes
	is_triggered_only = yes
	trigger = {
		has_origin = origin_birch
		is_ai = no
	}

	immediate = {
		set_global_flag = birch_black_hole_occured
		set_country_flag = found_giga_black_hole

		# Give key techs to make districts not dissappear
		give_technology = { tech = giga_tech_birch_world_1	message = no }
		# give_technology = { tech = giga_tech_birch_world_2	message = no }
		# give_technology = { tech = giga_tech_birch_world_3	message = no }
		# give_technology = { tech = giga_tech_birch_world_4	message = no }
		if = {
			limit = { country_uses_food = yes }
			give_technology = { tech = tech_hydroponics		message = no }
		}

		# Tag our old home planet
		capital_scope = {
			save_event_target_as = previous_home_planet
			solar_system = { save_event_target_as = previous_home_system }
			if = {
				limit = { exists = sector }
				sector = {
					leader = {
						unassign_leader = this
						save_event_target_as = birch_gov
					}
				}
			}
			else = {
				root = {
					random_owned_leader = {
						limit = { leader_class = governor }
						save_event_target_as = birch_gov
					}
				}
			}
		}

		# Spawn the Birch World System
		no_scope = {
			set_spawn_system_batch = begin
			spawn_system = { min_distance >= 0  max_distance <= 0	min_orientation_angle = 44  max_orientation_angle = 46  initializer = "giga_black_hole_core_initializer"	hyperlane = no }
			#last_created_system = { set_name = "Galactic Core" }
			last_created_system = { set_name = event_target:previous_home_system }
			spawn_system = { min_distance >= 30	max_distance <= 30	min_orientation_angle = 25	max_orientation_angle = 25	initializer = "giga_inner_1_initializer"			hyperlane = no }
			spawn_system = { min_distance >= 60	max_distance <= 60	min_orientation_angle = 90	max_orientation_angle = 90	initializer = "giga_inner_2_initializer"			hyperlane = no }
			spawn_system = { min_distance >= 25	max_distance <= 25	min_orientation_angle = 80	max_orientation_angle = 80	initializer = "giga_inner_3_initializer"			hyperlane = no }
			spawn_system = { min_distance >= 60	max_distance <= 60	min_orientation_angle = 130	max_orientation_angle = 130	initializer = "giga_inner_7_initializer"			hyperlane = no }
			spawn_system = { min_distance >= 60	max_distance <= 60	min_orientation_angle = 180	max_orientation_angle = 180	initializer = "giga_inner_4_initializer"			hyperlane = no }
			spawn_system = { min_distance >= 35	max_distance <= 35	min_orientation_angle = 220	max_orientation_angle = 220	initializer = "giga_inner_5_initializer"			hyperlane = no }
			spawn_system = { min_distance >= 60	max_distance <= 60	min_orientation_angle = 290	max_orientation_angle = 290	initializer = "giga_inner_6_initializer"			hyperlane = no }
			spawn_system = { min_distance >= 80	max_distance <= 80	min_orientation_angle = 110	max_orientation_angle = 110	initializer = "giga_outer_1_initializer"			hyperlane = no }
			spawn_system = { min_distance >= 90	max_distance <= 90	min_orientation_angle = 230	max_orientation_angle = 230	initializer = "giga_outer_2_initializer"			hyperlane = no }
			spawn_system = { min_distance >= 80	max_distance <= 80	min_orientation_angle = 350	max_orientation_angle = 350	initializer = "giga_outer_3_initializer"			hyperlane = no }

			add_hyperlane_safe = { from = event_target:giga_core_system	to = event_target:giga_inner_1 }
			add_hyperlane_safe = { from = event_target:giga_core_system	to = event_target:giga_inner_3 }
			add_hyperlane_safe = { from = event_target:giga_core_system	to = event_target:giga_inner_6 }
			add_hyperlane_safe = { from = event_target:giga_inner_1		to = event_target:giga_inner_2 }
			add_hyperlane_safe = { from = event_target:giga_inner_1		to = event_target:giga_inner_6 }
			add_hyperlane_safe = { from = event_target:giga_inner_2		to = event_target:giga_inner_4 }
			add_hyperlane_safe = { from = event_target:giga_inner_5		to = event_target:giga_inner_4 }
			add_hyperlane_safe = { from = event_target:giga_inner_5		to = event_target:giga_inner_6 }
			add_hyperlane_safe = { from = event_target:giga_inner_7		to = event_target:giga_inner_4 }
			add_hyperlane_safe = { from = event_target:giga_inner_2		to = event_target:giga_outer_1 }
			add_hyperlane_safe = { from = event_target:giga_inner_4		to = event_target:giga_outer_2 }
			add_hyperlane_safe = { from = event_target:giga_inner_6		to = event_target:giga_outer_3 }
			set_spawn_system_batch = end
		}

		event_target:giga_core_system = {
			set_star_flag = empire_cluster
			set_star_flag = empire_home_system

			star = {
				giga_set_has_mega_flag = yes
				change_planet_size = -10
				remove_deposit = yes
				random_list = {
					1 = { set_name = "Corey's Gut" }
					1 = { set_name = "Time's Agony" }
					1 = { set_name = "Undying Fury" }
					1 = { set_name = "Eternal Horizon" }
					1 = { set_name = "Sagittrevorius A" }
					1 = { set_name = "Pouchkinn's Vortex" }
					1 = { set_name = "The End" }
					1 = { set_name = "Voluptia" }
					1 = { set_name = "Powehi" }
					1 = { set_name = "Centaurus A" }
					1 = { set_name = "Cygnus X-1" }
					1 = { set_name = "Sagittarius A*" }
					1 = { set_name = "TON 618" }
					1 = { set_name = "Steve" }
					1 = { set_name = "Steeve" }
					1 = { set_name = "Sbeve" }
					1 = { set_name = "Twissell" }
					1 = { set_name = "Anulus" }
					1 = { set_name = "Aria" }
					1 = { set_name = "Nero" }
					1 = { set_name = "Temporal Itch" }
					1 = { set_name = "Stellar Beholder" }
					1 = { set_name = "Grim Reaper" }
					1 = { set_name = "dQw4w9WgXcQ" }
					1 = { set_name = "Shatterer of Behemoths" }
					1 = { set_name = "Grand Gargantua" }
					1 = { set_name = "111001" }
					1 = { set_name = "Great Mother" }
					1 = { set_name = "Placeholder black hole, real one is being renovated, apologies for the inconvenience" }
					1 = { set_name = "Despacito" }
					1 = { set_name = "siggatarius A*" }
				}
			}

			spawn_planet = {
				class = pc_origin_birch
				location = solar_system
				orbit_distance_offset = 1
				size = 500
				has_ring = no

				init_effect = {
					save_event_target_as = birch_world
					#set_name = "Birch World"
					set_name = event_target:previous_home_planet
					set_surveyed = { surveyed = yes surveyor = from }
					set_all_comms_surveyed = yes

					#giga_birch_setup = yes

					# deposits

					add_deposit = d_giga_birch_origin_home_insula
					add_deposit = d_giga_birch_origin_home_farms
					add_deposit = d_giga_birch_origin_home_mines
					add_deposit = d_giga_birch_origin_home_generators
					add_deposit = d_giga_birch_origin_home_labs

					if = { 
						limit = { root = { is_machine_empire = yes } }
						add_deposit = d_giga_birch_origin_home_machine_generators
					}
					if = { 
						limit = { root = { 
							or = {
								is_lithoid_empire = yes 
								has_country_flag = lithoid_subspecies
							}
						} }
						add_deposit = d_giga_birch_origin_home_lithoid_mines
					}
					if = { 
						limit = { root = { is_catalytic_empire = yes } }
						add_deposit = d_giga_birch_origin_home_catalytic_farms
					}
					
					# blockers

					if = { 
						limit = { root = { is_lithoid_empire = yes } }
						add_deposit = d_giga_birch_origin_lithoid_blocker
						add_deposit = d_giga_birch_origin_lithoid_blocker
						add_deposit = d_giga_birch_origin_lithoid_blocker
					}
				
				}
			}

			# Add a starbase
			create_starbase = {
				size = "starbase_starport"
				module = "shipyard"
				building = "crew_quarters"
				owner = root
				effect = { save_event_target_as = birch_starbase }
			}
		}

		# set off the exploration situation
		start_situation = {
			type = giga_situation_birch_origin
			target = event_target:birch_world
		}

		# Birch setup
		event_target:birch_world = {
			set_owner = root
			set_controller = root
			set_capital = yes
			set_sector_capital = yes
			sector = { assign_leader = event_target:birch_gov }

			# Buildings
			if = {
				limit = { owner = { is_regular_empire = yes } }
				add_building = building_capital
			}
			else_if = {
				limit = { owner = { is_hive_empire = yes } }
				add_building = building_hive_capital
				add_building = building_spawning_pool
			}
			else_if = {
				limit = { owner = { is_machine_empire = yes } }
				add_building = building_machine_capital
				add_building = building_machine_assembly_plant
			}

			# Districts
			while = {
				count = event_target:previous_home_planet.value:giga_num_districts|district|district_city|
				add_district = district_giga_planet_city
			}
			while = {
				count = event_target:previous_home_planet.value:giga_num_districts|district|district_hive|
				add_district = district_giga_planet_hive
			}
			while = {
				count = event_target:previous_home_planet.value:giga_num_districts|district|district_nexus|
				add_district = district_giga_planet_nexus
			}

			while = {
				count = event_target:previous_home_planet.value:giga_num_districts|district|district_industrial|
				add_district = district_industrial
			}

			while = {
				count = event_target:previous_home_planet.value:giga_num_districts|district|district_farming|
				add_district = district_giga_planet_farming
			}
			while = {
				count = event_target:previous_home_planet.value:giga_num_districts|district|district_mining|
				add_district = district_giga_planet_mining
			}
			while = {
				count = event_target:previous_home_planet.value:giga_num_districts|district|district_generator|
				add_district = district_giga_planet_generator
			}

			add_district = district_giga_origin_birch_lab
		}

		# Move player ships
		every_owned_fleet = {
			limit = {
				any_owned_ship = {
					OR = {
						is_ship_size = constructor
						is_ship_size = corvette
						is_ship_size = science
					}
				}
			}
			set_location = event_target:birch_starbase
			if = {
				limit = { any_owned_ship = { is_ship_size = corvette } }
				set_home_base = event_target:birch_starbase
			}
		}

		# Remove the old home planet
		event_target:previous_home_planet = {
			every_owned_pop = {
				if = {
					limit = {
						is_robot_pop = no
						is_sapient = yes
					}
					modify_species = { ideal_planet_class = pc_birch }
				}

				unemploy_pop = yes
				resettle_pop = { pop = this planet = event_target:birch_world }
			}
			change_pc = pc_nuked
			destroy_colony = yes
			#reroll_planet = yes
		}

		event_target:birch_world = {
			every_owned_pop = {
				unemploy_pop = yes
				clear_pop_category = yes
			}
			# since it doesn't like to move many pops at the same time sometimes...
			while = {
				count = 40
				check_planet_employment = yes
			}
		}

		# unclaim the old home system
		event_target:previous_home_system = {
			every_fleet_in_system = { delete_fleet = this }
			remove_star_flag = empire_home_system
			remove_star_flag = empire_cluster
			every_neighbor_system = {
				remove_star_flag = empire_cluster
				every_neighbor_system = { remove_star_flag = empire_cluster }
			}
		}

		# Set species homeworld
		owner_species = { set_species_homeworld = event_target:birch_world }
		every_owned_pop_species = { set_species_homeworld = event_target:birch_world }
	}
}

# Called by player pressing start.
country_event = {
	id = giga_birch.002
	title = "giga_birch.title"
	desc = "giga_birch.desc"
	picture = GFX_evt_black_hole
	show_sound = event_sensor_ping

	is_triggered_only = yes
	trigger = { has_origin = origin_birch }

	option = {
		name = "giga_mega.403.a"
		enable_special_project = {
			name = "INVESTIGATE_GALACTIC_CORE_LINK"
			owner = root
		}
		capital_scope = {
			set_planet_flag = giga_core_sp_here@root
		}
	}
}

# Perform linking
country_event = {
	id = giga_birch.003
	title = "giga_birch.003.name"
	desc = { trigger = { has_country_flag = birch_completed_hyperlane_project }			text = "giga_birch.003.desc" }
	desc = { trigger = { NOT = { has_country_flag = birch_completed_hyperlane_project } }	text = "giga_birch.003.desc2" }
	picture = GFX_evt_black_hole
	show_sound = event_sensor_ping
	is_triggered_only = yes
	fire_only_once = yes
	option = { name = OK }

	immediate = {
		set_spawn_system_batch = begin
		event_target:giga_outer_1 = {
			random_list = {
				1 = { while = { count = 1 giga_generate_hyperlane = yes } }
				1 = { while = { count = 2 giga_generate_hyperlane = yes } }
			}
		}
		event_target:giga_outer_2 = {
			random_list = {
				1 = { while = { count = 1 giga_generate_hyperlane = yes } }
				1 = { while = { count = 2 giga_generate_hyperlane = yes } }
			}
		}
		event_target:giga_outer_3 = {
			random_list = {
				1 = { while = { count = 1 giga_generate_hyperlane = yes } }
				1 = { while = { count = 2 giga_generate_hyperlane = yes } }
			}
		}
		set_spawn_system_batch = end
	}
}

# Force link in the midgame if the player hasn't done it themselves.
country_event = {
	id = giga_birch.004
	hide_window = yes
	is_triggered_only = yes
	fire_only_once = yes

	trigger = {
		has_origin = origin_birch
		OR = {
			mid_game_years_passed >= 1
			years_passed >= 100
		}
	}

	immediate = {
		capital_scope = {
			save_event_target_as = birch_capital
			remove_planet_flag = giga_core_sp_here@root
		}
		abort_special_project = { type = "INVESTIGATE_GALACTIC_CORE_LINK" location = event_target:birch_capital }
		country_event = { id = giga_birch.003 }
	}
}

#########################################################################################################################################
#########################################################################################################################################
#########################################################################################################################################

# Origin Situation Events

# first expedition
# searching for a way down, find many inactive pillars before coming across an abandoned settlement

situation_event = {
	id = giga_birch.1000
	is_triggered_only = yes
	hide_window = yes

	# create and exile a scientist to be the expedition's leader
	immediate = {
		save_event_target_as = situation
		set_situation_flag = expedition_underway

		owner = {
			create_leader = {
				class = scientist
				species = owner_main_species
				name = random
			}
			last_created_leader = {
				exile_leader_as = giga_birch_expedition_leader
				save_event_target_as = giga_birch_expedition_leader
				set_immortal = yes
			}
		}		
	}

	after = {
		owner = {
			country_event = {
				id = giga_birch.1001
			}
		}
	}
}

# expedition embarks
country_event = {
	id = giga_birch.1001
	is_triggered_only = yes
	picture = GFX_evt_busy_spaceport
	title = giga_birch.1001
	desc = giga_birch.1001.desc

	option = {
		name = giga_birch.1001.a
		hidden_effect = {
			country_event = {
				id = giga_birch.1002
				days = 35
			}
		}
	}
}

# expedition finds an abandond settlement surrounding a pillar, begins investigation
country_event = {
	id = giga_birch.1002
	is_triggered_only = yes
	picture = GFX_evt_baol_ruins
	title = giga_birch.1002
	desc = giga_birch.1002.desc

	option = {
		name = giga_birch.1002.a
		hidden_effect = {
			country_event = {
				id = giga_birch.1003
				days = 12
			}
		}
	}
}

# expedition finds no way down, but does find usable facilities
country_event = {
	id = giga_birch.1003
	is_triggered_only = yes
	picture = GFX_evt_ancient_records
	title = giga_birch.1003
	desc = giga_birch.1003.desc

	option = {
		name = giga_birch.1003.a # artisans
		trigger = {
			owner = {
				country_uses_consumer_goods = yes
			}
		}
		
		custom_tooltip = giga_birch.1003.a.desc
		hidden_effect = { event_target:situation.target = { set_planet_flag = birch_expedition_1_factory } }
	}
	
	option = {
		name = giga_birch.1003.b # scrap miners
		
		custom_tooltip = giga_birch.1003.b.desc
		hidden_effect = { event_target:situation.target = { set_planet_flag = birch_expedition_1_miners } }

		ai_chance = {
			modifier = {
				factor = 5
				owner = { is_lithoid_empire = yes }
			}
		}
	}

	option = {
		name = giga_birch.1003.c # technicians
		
		custom_tooltip = giga_birch.1003.c.desc
		hidden_effect = { event_target:situation.target = { set_planet_flag = birch_expedition_1_technicians } }

		ai_chance = {
			modifier = {
				factor = 3
				owner = { is_machine_empire = yes }
			}
		}
	}

	option = {
		name = giga_birch.1003.d # farmers
		trigger = {
			owner = {
				country_uses_food = yes
			}
		}
		
		custom_tooltip = giga_birch.1003.d.desc
		hidden_effect = { event_target:situation.target = { set_planet_flag = birch_expedition_1_farmers } }

		ai_chance = {
			modifier = {
				factor = 5
				owner = { is_catalytic_empire = yes }
			}
		}
	}
	
	after = {
		event_target:situation.target = { add_deposit = d_giga_birch_expedition_1 }
		hidden_effect = {
			country_event = {
				id = giga_birch.1004
				days = 5
			}
		}
	}
}

# conclusion
country_event = {
	id = giga_birch.1004
	is_triggered_only = yes
	picture = GFX_evt_ancient_alien_temple
	title = giga_birch.1004
	desc = giga_birch.1004.desc

	option = {
		name = giga_birch.1004.a
		hidden_effect = {
			event_target:situation = { remove_situation_flag = expedition_underway }
		}
	}
}

#########################################################################################################################################

# second expedition
# searching again for a way down, find a populated settlement, spend time dealing with them

situation_event = {
	id = giga_birch.2000
	is_triggered_only = yes
	hide_window = yes

	# create expedition leader and discovered civ
	immediate = {
		save_event_target_as = situation
		set_situation_flag = expedition_underway

		owner = {
			create_leader = {
				class = scientist
				species = owner_main_species
				name = random
			}
			last_created_leader = {
				exile_leader_as = giga_birch_expedition_leader
				save_event_target_as = giga_birch_expedition_leader
				set_immortal = yes
			}
		}

		# other species
		create_species = {
			class = random_non_machine
			homeworld = root.target
		}
		last_created_species = {
			save_event_target_as = giga_birch_expeiditon_2_species
		}

		# their empire, and leader
		create_country = {
			type = giga_birch_natives
			species = event_target:giga_birch_expeiditon_2_species
			ethos = random
			civics = random
			auto_delete = no
			government_restrictions = {
				authority = { 
					nor = { 
						value = auth_machine_intelligence # need normal empires
						value = auth_hive_mind 
					} 
				}
				ethics = {
					nor = {
						value = ethic_fanatic_xenophobe # no xenophobes so it's not instant rejection
						value = ethic_xenophobe
						value = ethic_fanatic_spiritualist # no fanatic spiritualists to reject machines
					}
				}
			}
		}
		last_created_country = {
			save_event_target_as = giga_birch_expeiditon_2_country
			establish_communications_no_message = root.owner
			create_leader = {
				class = ruler
				species = event_target:giga_birch_expeiditon_2_species
				name = random
			}
			last_created_leader = {
				save_event_target_as = giga_birch_expeiditon_2_ruler
				set_immortal = yes
			}
			set_leader = last_created_leader
		}
	}

	after = {
		owner = {
			country_event = {
				id = giga_birch.2001
			}
		}
	}
}

country_event = {
	id = giga_birch.2001
	is_triggered_only = yes
	picture = GFX_evt_ancient_alien_temple
	title = giga_birch.2001
	desc = giga_birch.2001.desc

	option = {
		name = giga_birch.2001.a
		# hidden_effect = {
		# 	country_event = {
		# 		id = giga_birch.1002
		# 		scopes = { from = from }
		# 		days = 70
		# 	}
		# }
	}
}

#########################################################################################################################################

# third expedition
# searching again for a way down, find an active pillar, activate and establish a forward base

situation_event = {
	id = giga_birch.3000
	is_triggered_only = yes
	picture = GFX_evt_archaeological_dig

	option = {
		name = OK
	}
}

#########################################################################################################################################

# fourth expedition
# explore a lower layer, filled with machinery, fire up a fabrication complex

situation_event = {
	id = giga_birch.4000
	is_triggered_only = yes
	picture = GFX_evt_archaeological_dig

	option = {
		name = OK
	}
}

#########################################################################################################################################

# fifth expedition
# explore the layer further, find a regional administration centre, start it back up, revive some systems
# requires mega-engineering for the project

situation_event = {
	id = giga_birch.5000
	is_triggered_only = yes
	picture = GFX_evt_archaeological_dig

	option = {
		name = OK
	}
}

#########################################################################################################################################

# sixth expedition
# with that online, travel further down, find another landscape layer with a different climate

situation_event = {
	id = giga_birch.6000
	is_triggered_only = yes
	picture = GFX_evt_archaeological_dig

	option = {
		name = OK
	}
}

#########################################################################################################################################

# seventh expedition
# explore the new landscape layer, find an observation and science complex, start it up

situation_event = {
	id = giga_birch.7000
	is_triggered_only = yes
	picture = GFX_evt_archaeological_dig

	option = {
		name = OK
	}
}

#########################################################################################################################################

# eighth expedition
# identify another command centre, it's 4d and needs powering back up, which starts more systems but they are at low power
# requires tetradimensional engineering for the project

situation_event = {
	id = giga_birch.8000
	is_triggered_only = yes
	picture = GFX_evt_archaeological_dig

	option = {
		name = OK
	}
}

#########################################################################################################################################

# ninth expedition
# descend to the lowest levels, where the black hole gathering machines are to restore power

situation_event = {
	id = giga_birch.9000
	is_triggered_only = yes
	picture = GFX_evt_archaeological_dig

	option = {
		name = OK
	}
}

#########################################################################################################################################

# the final push
# with everything in place, unlock the project to restore the birch fully by properly powering up its self repair systems

situation_event = {
	id = giga_birch.10000
	is_triggered_only = yes
	picture = GFX_evt_archaeological_dig

	option = {
		name = OK
	}
}
