
# this = country scope
giga_amb_apply_initial_country_modifiers = {
	set_country_flag = @giga_amb_init_flag

	add_modifier = {
		modifier = giga_amb_base
	}

	set_variable = {
		which = giga_amb_ratio
		value = @giga_amb_ratio
	}

	# assign the bonus to empires which rely a lot on mega build speed in early game
	if = {
		limit = {
			or = {
				has_origin = origin_void_dwellers
				has_origin = origin_frameworld
			}
		}

		capital_scope = {
			add_deposit = d_giga_amb_start_bonus
		}
		add_research_option = giga_tech_amb_supertensiles
	}
}

# this = country scope
giga_amb_recalculate_country_modifiers = {

	# remove calc modifiers
	set_update_modifiers_batch = begin

	remove_modifier = giga_amb_flat_replacement
	remove_modifier = giga_amb_speed
	remove_modifier = giga_amb_storage_capacity

	set_update_modifiers_batch = end # this forces a recalculation of modifers so the next part reads the modifier values without these modifiers

	# read resource capacity mod to var
	export_modifier_to_variable = {
		modifier = country_resource_max_add
		variable = giga_amb_storage_capacity
	}
	# add resource capacity adjustment
	add_modifier = {
		modifier = giga_amb_storage_capacity
		multiplier = giga_amb_storage_capacity
	}

	# read cap mod to var
	export_modifier_to_variable = {
		modifier = country_megastructure_build_cap_add
		variable = giga_amb_cap
	}
	change_variable = {
		which = giga_amb_cap
		value = -999
	}

	# read base speed to var
	export_modifier_to_variable = {
		modifier = megastructure_build_speed_add
		variable = giga_amb_flat
	}
	change_variable = {
		which = giga_amb_flat
		value = 1
	}
	
	# add calc flat replacement modifier if the value is > 0
	if = {
		limit = {
			check_variable = {
				which = giga_amb_flat
				value > 0
			}
		}
		add_modifier = {
			modifier = giga_amb_flat_replacement
			multiplier = giga_amb_flat
		}
	}

	# get mega job income
	export_resource_income_to_variable = {
		resource = giga_amb_megaconstruction
		variable = giga_amb_income
	}

	# get stockpile drain
	set_variable = {
		which = giga_amb_stockpile
		value = value:giga_amb_stockpile_calc
	}

	# calculate total progress
	set_variable = {
		which = giga_amb_total_progress
		value = value:giga_amb_total_progress_calc
	}

	# count all building megas
	set_variable = {
		which = giga_amb_building_megas
		value = value:giga_amb_building_megas_calc
	}

	# subtract drain from stockpile if there's at least one running project
	if = {
		limit = {
			check_variable = {
				which = giga_amb_building_megas
				value > 0
			}
		}

		add_resource = {
			giga_amb_megaconstruction = -1
			mult = giga_amb_stockpile
		}
	}

	# calc progress per mega
	set_variable = {
		which = giga_amb_progress
		value = value:giga_amb_progress_calc
	}

	# add the final progress modifier
	add_modifier = {
		modifier = giga_amb_speed
		multiplier = giga_amb_progress
	}
}